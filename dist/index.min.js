"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Get=function(e,t){if(t)return(t=t.split(".")).reduce(function(e,t){return e&&e[t]?e[t]:null},e)},Set=function(i,e,n){if(e){var r=e.split(".");return r.forEach(function(e,t){t===r.length-1&&(i[e]=n),null==i[e]&&(isNaN(r[t+1])?i[e]={}:i[e]=[]),i=i[e]}),i}},left="LEFT",right="RIGHT",up="UP",down="DOWN",enter="ENTER",KeyCodes={map:{LEFT:left,RIGHT:right,UP:up,DOWN:down,ENTER:enter},codes:{4:left,21:left,37:left,214:left,205:left,218:left,5:right,22:right,39:right,213:right,206:right,217:right,29460:up,19:up,38:up,211:up,203:up,215:up,29461:down,20:down,40:down,212:down,204:down,216:down,29443:enter,13:enter,67:enter,32:enter,23:enter,195:enter}};function mitt(n){return n=n||Object.create(null),{on:function(e,t){(n[e]||(n[e]=[])).push(t)},off:function(e,t){n[e]&&n[e].splice(n[e].indexOf(t)>>>0,1)},emit:function(t,i){(n[t]||[]).slice().map(function(e){e(i)}),(n["*"]||[]).slice().map(function(e){e(t,i)})}}}var Closest=function(e,i){return e.reduce(function(e,t){return Math.abs(t-i)<Math.abs(e-i)?t:e})},isFocusable=function(e){return!(!e.selectAction&&!e.isFocusable)},getDirectionForKeyCode=function(e){var t=KeyCodes.codes[e];return t?t.toUpperCase():null},Lrud=function(){function e(){this.tree={},this.nodePathList=[],this.focusableNodePathList=[],this.rootNodeId=null,this.currentFocusNodeId=null,this.currentFocusNodeIndex=null,this.currentFocusNodeIndexRange=null,this.isIndexAlignMode=!1,this.emitter=new mitt,this.overrides={}}return e.prototype.isDirectionAndOrientationMatching=function(e,t){return!(!e||!t)&&(e=e.toUpperCase(),"*"===(t=t.toUpperCase())||"VERTICAL"===e&&("UP"===t||"DOWN"===t)||"HORIZONTAL"===e&&("LEFT"===t||"RIGHT"===t))},e.prototype.on=function(e,t){this.emitter.on(e,t)},e.prototype.getRootNode=function(){var e=this.getNode(this.rootNodeId);if(!e)throw new Error("no root node");return e},e.prototype.getPathForNodeId=function(t){return t===this.rootNodeId?this.rootNodeId:this.nodePathList.find(function(e){return e.endsWith("."+t)})},e.prototype.registerNode=function(e,t){if(void 0===t&&(t={}),t.id||(t.id=e),Object.keys(this.tree).length<=0)return this.rootNodeId=e,this.tree[e]=t,this.nodePathList.push(e),this;if(null==t.parent&&e!==this.rootNodeId&&(t.parent=this.rootNodeId),null==this.nodePathList.find(function(e){return e.includes(t.parent+".children")})){var i=this.getPathForNodeId(t.parent);Set(this.tree,i+".activeChild",e)}if(!t.index&&this.getNode(t.parent)){var n=this.getNode(t.parent).children;t.index=n?Object.keys(n).length:0}var r=this.nodePathList.find(function(e){return e.endsWith(t.parent)})+".children."+e;return Set(this.tree,r,t),this.nodePathList.push(r),isFocusable(t)&&this.focusableNodePathList.push(r),this},e.prototype.register=function(e,t){return void 0===t&&(t={}),this.registerNode(e,t)},e.prototype.unregisterNode=function(t){var i=this,e=this.getPathForNodeId(t);if(e){var n=Get(this.tree,e),r=this.getNode(n.parent);if(delete r.children[t],this.nodePathList.splice(this.nodePathList.indexOf(e),1),this.nodePathList=this.nodePathList.filter(function(e){return!e.includes("."+t)}),this.focusableNodePathList=this.focusableNodePathList.filter(function(e){return!e.includes("."+t)}),r.activeChild&&r.activeChild===t){delete r.activeChild;var o=this.climbUp(r,"*"),d=this.getPrevChild(o),s=this.digDown(d);this.assignFocus(s.id)}return this._reindexChildrenOfNode(r),Set(this.tree,this.getPathForNodeId(r.id),r),this.emitter.emit("blur",n),n.onBlur&&n.onBlur(n),Object.keys(this.overrides).forEach(function(e){var t=i.overrides[e];t.target!==n.id&&t.id!==n.id||i.unregisterOverride(e)}),this}},e.prototype.registerOverride=function(e,t){if(!e)throw new Error("need an ID to register an override");if(this.overrides[e])throw new Error("override with ID of "+e+" already exists");if(!t.id)throw new Error("registering override: "+e+" - missing internal id");if(!t.direction)throw new Error("registering override: "+e+" - missing internal direction");if(!t.target)throw new Error("registering override: "+e+" - missing internal target");return this.overrides[e]=t,this},e.prototype.unregisterOverride=function(e){return delete this.overrides[e],this},e.prototype.getNode=function(e){return Get(this.tree,this.getPathForNodeId(e))},e.prototype.pickNode=function(e){var t=this.getNode(e);if(t)return this.unregisterNode(e),t},e.prototype._isNodeInFocusableNodePathList=function(t){var i=this;return this.focusableNodePathList.some(function(e){return!!e.includes("."+t.id+".")||!(t.id!==i.rootNodeId||!e.includes(t.id+"."))})},e.prototype.climbUp=function(i,n){var r=this;if(!i)return null;var e=Object.keys(this.overrides).find(function(e){var t=r.overrides[e];return t.id===i.id&&t.direction.toUpperCase()===n.toUpperCase()});if(e)return this.getNode(this.overrides[e].target);if(isFocusable(i))return this.climbUp(this.getNode(i.parent),n);if(!this._isNodeInFocusableNodePathList(i))return this.climbUp(this.getNode(i.parent),n);if(!this.isDirectionAndOrientationMatching(i.orientation,n))return this.climbUp(this.getNode(i.parent),n);var t=this.getNextChildInDirection(i,n);if(!t)return i;var o=t&&t.id===i.activeChild,d=isFocusable(this.getNode(i.activeChild)),s=this._isNodeInFocusableNodePathList(i);return o&&(d||s)?this.climbUp(this.getNode(i.parent),n):i},e.prototype.digDown=function(e){if(isFocusable(e))return e;var t=this.getNode(e.parent);if(this.isIndexAlignMode&&("vertical"!==e.orientation||"vertical"!==t.orientation)){var i=this._findChildWithMatchingIndexRange(e,this.currentFocusNodeIndex);i||(i=this._findChildWithClosestIndex(e,this.currentFocusNodeIndex,this.currentFocusNodeIndexRange)),i&&(e.activeChild=i.id)}e.activeChild||(e.activeChild=this.getNodeFirstChild(e).id);var n=this.getNode(e.activeChild);return isFocusable(n)?n:this.digDown(n)},e.prototype._findChildWithMatchingIndexRange=function(i,n){if(!i.children)return null;var e=Object.keys(i.children).find(function(e){var t=i.children[e];return t.indexRange&&t.indexRange[0]<=n&&t.indexRange[1]>=n});return e?i.children[e]:void 0},e.prototype._findChildWithClosestIndex=function(t,e,i){if(void 0===i&&(i=null),!t.children)return null;var n=this.getNode(t.activeChild);if(i&&n&&n.index>=i[0]&&n.index<=i[1])return n;var r=Object.keys(t.children).map(function(e){return t.children[e].index});return this._findChildWithIndex(t,Closest(r,e))},e.prototype._findChildWithIndex=function(t,i){if(!t.children)return null;var e=Object.keys(t.children).find(function(e){return t.children[e].index===i});return e?t.children[e]:null},e.prototype._reindexChildrenOfNode=function(i){if(i.children){var e=Object.keys(i.children).map(function(e){return i.children[e]});return e.sort(function(e,t){return e.index-t.index}),i.children={},e.forEach(function(e,t){e.index=t,i.children[e.id]=e}),Set(this.tree,this.getPathForNodeId(i.id),i),i}},e.prototype.getNextChildInDirection=function(e,t){return t=t.toUpperCase(),"horizontal"===e.orientation&&"RIGHT"===t?this.getNextChild(e):"horizontal"===e.orientation&&"LEFT"===t?this.getPrevChild(e):"vertical"===e.orientation&&"DOWN"===t?this.getNextChild(e):"vertical"===e.orientation&&"UP"===t?this.getPrevChild(e):null},e.prototype.getNextChild=function(e){e.activeChild||(e.activeChild=this.getNodeFirstChild(e).id);var t=e.children[e.activeChild].index,i=this._findChildWithIndex(e,t+1);return i||(i=e.isWrapping?this.getNodeFirstChild(e):e.children[e.activeChild]),i},e.prototype.getPrevChild=function(e){e.activeChild||(e.activeChild=this.getNodeFirstChild(e).id);var t=e.children[e.activeChild].index,i=this._findChildWithIndex(e,t-1);return i||(i=e.isWrapping?this.getNodeLastChild(e):e.children[e.activeChild]),i},e.prototype.getNodeFirstChild=function(t){if(t.children){var e=Object.keys(t.children).map(function(e){return t.children[e].index}).sort();return this._findChildWithIndex(t,e[0])}},e.prototype.getNodeLastChild=function(t){if(t.children){var e=Object.keys(t.children).map(function(e){return t.children[e].index}).sort();return this._findChildWithIndex(t,e[e.length-1])}},e.prototype.handleKeyEvent=function(e){var t=e.keyCode?getDirectionForKeyCode(e.keyCode):e.direction.toUpperCase(),i=this.getNode(this.currentFocusNodeId);if("ENTER"===t&&i.onSelect)return this.emitter.emit("select",i),void i.onSelect(i);var n=this.climbUp(i,t);if(n){this.isIndexAlignMode=!0===n.isIndexAlign;var r=this.getNextChildInDirection(n,t),o=r?this.digDown(r):this.digDown(n);return this.assignFocus(o.id),this.emitter.emit("move",{leave:i,enter:o,direction:t,offset:"LEFT"===t||"UP"===t?-1:1}),n.onMove&&n.onMove({node:n,leave:i,enter:o,direction:t,offset:"LEFT"===t||"UP"===t?-1:1}),i.onLeave&&i.onLeave(i),o.onEnter&&o.onEnter(o),o}},e.prototype._setActiveChild=function(e,t){var i=this.getNode(t),n=this.getNode(e);if(i){if(n.activeChild&&n.activeChild!==i.id){var r=this.getNode(n.activeChild);n.activeChild=i.id,this.emitter.emit("inactive",r),r.onInactive&&r.onInactive(r),this.emitter.emit("active",i),i.onActive&&i.onActive(i),n.onActiveChildChange&&n.onActiveChildChange({node:n,leave:r,enter:i})}n.parent&&this._setActiveChild(n.parent,n.id)}},e.prototype.assignFocus=function(e){var t=this.getNode(e);if(isFocusable(t)||(t=this.digDown(t)),!t)throw new Error("trying to assign focus to a non focusable node");if(this.currentFocusNodeId){var i=this.getNode(this.currentFocusNodeId);i&&(this.emitter.emit("blur",i),i.onBlur&&i.onBlur(i))}this.currentFocusNodeId=t.id,t.indexRange?(this.currentFocusNodeIndex=t.indexRange[0],this.currentFocusNodeIndexRange=t.indexRange):this.currentFocusNodeIndex=t.index,t.parent&&this._setActiveChild(t.parent,t.id),t.onFocus&&t.onFocus(t),this.emitter.emit("focus",t)},e}();exports.Lrud=Lrud;